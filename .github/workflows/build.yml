name: 'build'

env:
  GO_VERSION: '1.25.7'
  NODE_VERSION: '20'

on:
  push:
    branches:
    - '*'
    tags:
    - 'v*'
  pull_request:
  workflow_dispatch:
  star:
    types: [created]

jobs:
  build-release:
    runs-on: 'ubuntu-latest'
    # å¦‚æœä¹‹å‰æœ‰ needs: testï¼Œç°åœ¨ç§»é™¤
    steps:
    - name: 'Checkout'
      uses: 'actions/checkout@v2'
      with:
        fetch-depth: 0
    - name: 'Set up Go'
      uses: 'actions/setup-go@v3'
      with:
        go-version: '${{ env.GO_VERSION }}'
    - name: 'Set up Node'
      uses: 'actions/setup-node@v1'
      with:
        node-version: '${{ env.NODE_VERSION }}'
    - name: 'Set up Go modules cache'
      uses: 'actions/cache@v4'
      with:
        path: '~/go/pkg/mod'
        key: "${{ runner.os }}-go-${{ hashFiles('go.sum') }}"
        restore-keys: '${{ runner.os }}-go-'
    - name: 'Get npm cache directory'
      id: 'npm-cache'
      run: 'echo "::set-output name=dir::$(npm config get cache)"'
    - name: 'Set up npm cache'
      uses: 'actions/cache@v4'
      with:
        path: '${{ steps.npm-cache.outputs.dir }}'
        key: "${{ runner.os }}-node-${{ hashFiles('client/package-lock.json') }}"
        restore-keys: '${{ runner.os }}-node-'
    - name: 'Set up Snapcraft'
      run: 'sudo snap install snapcraft --classic'
    - name: 'Set up QEMU'
      uses: 'docker/setup-qemu-action@v3'
    - name: 'Set up Docker Buildx'
      uses: 'docker/setup-buildx-action@v3'
      with:
        install: true

    # æ ¸å¿ƒæ„å»ºæ­¥éª¤ï¼ˆå·²è®¾ç½®ç‰ˆæœ¬å’Œå¹³å°é™åˆ¶ï¼‰
    - name: 'Run snapshot build'
      run: 'make SIGN=0 VERBOSE=1 VERSION="v999.999.999" build-release'

  # å¦‚æœä¸éœ€è¦ notify å’Œ respond-to-starï¼Œä¹Ÿå¯ä»¥åˆ é™¤
  # ä½†ä¸ºäº†ä¿æŒå®Œæ•´ï¼Œå¯ä¿ç•™æˆ–æŒ‰éœ€åˆ é™¤
  notify:
    needs:
    - 'build-release'
    if: |
      always() &&
      github.repository_owner == 'AdguardTeam' &&
      (
        github.event_name == 'push' ||
        github.event.pull_request.head.repo.full_name == github.repository
      )
    runs-on: 'ubuntu-latest'
    steps:
    - name: 'Conclusion'
      uses: 'technote-space/workflow-conclusion-action@v1'
    - name: 'Send Slack notif'
      uses: '8398a7/action-slack@v3'
      with:
        status: '${{ env.WORKFLOW_CONCLUSION }}'
        fields: 'repo, message, commit, author, workflow'
      env:
        GITHUB_TOKEN: '${{ secrets.GITHUB_TOKEN }}'
        SLACK_WEBHOOK_URL: '${{ secrets.SLACK_WEBHOOK_URL }}'

  respond-to-star:
    if: github.event_name == 'star'
    runs-on: ubuntu-latest
    steps:
      - name: Star received
        run: |
          echo "ğŸ‰ Thank you for starring the repository!"
          echo "Stargazer: ${{ github.event.sender.login }}"
          echo "Total stars: ${{ github.repository.stargazers_count }}"