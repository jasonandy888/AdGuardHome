name: 'build'

env:
  GO_VERSION: '1.25.7'
  NODE_VERSION: '20'

on:
  push:
    branches:
    - '*'
    tags:
    - 'v*'
  pull_request:
  workflow_dispatch:

jobs:
  build-release:
    runs-on: 'ubuntu-latest'
    steps:
      - name: 'Checkout'
        uses: 'actions/checkout@v4'
        with:
          fetch-depth: 0

      - name: 'Set up Go'
        uses: 'actions/setup-go@v5'
        with:
          go-version: '${{ env.GO_VERSION }}'

      - name: 'Set up Node'
        uses: 'actions/setup-node@v4'
        with:
          node-version: '${{ env.NODE_VERSION }}'

      - name: 'Set up Go modules cache'
        uses: 'actions/cache@v4'
        with:
          path: '~/go/pkg/mod'
          key: "${{ runner.os }}-go-${{ hashFiles('go.sum') }}"
          restore-keys: '${{ runner.os }}-go-'

      - name: 'Get npm cache directory'
        id: 'npm-cache'
        run: echo "dir=$(npm config get cache)" >> $GITHUB_OUTPUT

      - name: 'Set up npm cache'
        uses: 'actions/cache@v4'
        with:
          path: '${{ steps.npm-cache.outputs.dir }}'
          key: "${{ runner.os }}-node-${{ hashFiles('client/package-lock.json') }}"
          restore-keys: '${{ runner.os }}-node-'

      # 核心构建：只编译两个指定平台（需确保 build-release.sh 中 platforms 已精简）
      - name: 'Run snapshot build'
        run: 'make SIGN=0 VERBOSE=1 VERSION="v999.999.999" build-release'

      # 上传构建产物，供后续作业使用或直接下载
      - name: 'Upload artifacts'
        uses: 'actions/upload-artifact@v4'
        with:
          name: 'AdGuardHome-builds'
          path: './dist/'
          retention-days: 1

  release:
    needs: build-release
    runs-on: ubuntu-latest
    # 仅在推送版本标签时运行
    if: startsWith(github.ref, 'refs/tags/v')
    steps:
      - name: 'Download built artifacts'
        uses: 'actions/download-artifact@v4'
        with:
          name: 'AdGuardHome-builds'
          path: './dist'

      - name: 'Create GitHub Release'
        uses: 'softprops/action-gh-release@v2'
        with:
          files: './dist/*'
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: '${{ secrets.GITHUB_TOKEN }}'